<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Asper-Bot OS - Cara del Robot</title>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden; color: white; font-family: 'Segoe UI', sans-serif;
        }

        #video-container { width: 90vh; height: 90vh; display: flex; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; object-fit: contain; }

        #status-container {
            position: absolute; bottom: 8%; width: 80%; max-width: 700px; z-index: 10;
        }

        #status {
            background: rgba(0, 0, 0, 0.75);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            min-height: 50px;
        }

        .user-text { color: #888; font-size: 0.8rem; margin-bottom: 5px; text-transform: uppercase; }
        .bot-text { color: #00d4ff; font-size: 1.3rem; font-weight: 300; }

        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100; 
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 1.2rem; letter-spacing: 2px;
        }
    </style>
</head>
<body>

    <audio id="audioBip" src="static/bip.mp3" preload="auto"></audio>
    <audio id="audioVoz" preload="auto"></audio>

    <div id="start-overlay" onclick="iniciarSistema()">
        TOQUE PARA INICIALIZAR ASISTENTE CONTINUO
    </div>

    <div id="video-container">
        <video id="ojosVideo" muted loop>
            <source src="static/ojosvideo.mp4" type="video/mp4">
        </video>
    </div>

    <div id="status-container">
        <div id="status">
            <span class="bot-text">SISTEMA EN REPOSO</span>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN DE SINCRONIZACIÓN ---
        const API_URL = "https://asperweb.onrender.com"; 

        const statusDiv = document.getElementById('status');
        const videoOjos = document.getElementById('ojosVideo');
        const bip = document.getElementById('audioBip');
        const audioVoz = document.getElementById('audioVoz');

        // Configuración de Reconocimiento de Voz del Navegador
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'es-MX';
        recognition.interimResults = false;

        function iniciarSistema() {
            document.getElementById('start-overlay').style.display = 'none';
            ejecutarCicloContinuo();
        }

        async function ejecutarCicloContinuo() {
            bip.play().catch(e => console.log("Error de audio:", e));
            statusDiv.innerHTML = "<span class='user-text'>[ ESCUCHANDO... ]</span>";
            
            try {
                recognition.start();
            } catch (e) {
                console.log("Reconocimiento ya activo");
            }
        }

        recognition.onresult = async (event) => {
            const textoVoz = event.results[0][0].transcript;
            statusDiv.innerHTML = `<div class="user-text">Procesando: "${textoVoz}"</div>`;

            try {
                // 1. Enviar texto a Render
                const res = await fetch(`${API_URL}/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ texto: textoVoz })
                });
                const data = await res.json();

                statusDiv.innerHTML = `
                    <div class="user-text">TÚ: "${textoVoz}"</div>
                    <div class="bot-text">${data.respuesta}</div>
                `;

                // 2. Obtener y reproducir voz de Edge-TTS desde Render
                audioVoz.src = `${API_URL}/tts?texto=${encodeURIComponent(data.respuesta)}`;
                
                audioVoz.onplay = () => videoOjos.play();
                audioVoz.onended = () => {
                    videoOjos.pause();
                    videoOjos.currentTime = 0;
                    setTimeout(ejecutarCicloContinuo, 500);
                };
                
                audioVoz.play();

            } catch (e) {
                console.error("Error de conexión:", e);
                statusDiv.innerHTML = "<span class='bot-text'>ERROR DE CONEXIÓN</span>";
                setTimeout(ejecutarCicloContinuo, 3000);
            }
        };

        recognition.onerror = (event) => {
            console.log("Error de micro:", event.error);
            setTimeout(ejecutarCicloContinuo, 1000);
        };

    </script>
</body>
</html>
